{"version":3,"file":"Provider.js","names":["createContext","useRef","newServerState","IS_DOM_ENVIRONMENT","calcAggregatedState","commitTagChanges","jsx","_jsx","Context","undefined","HelmetProvider","_ref","children","context","current","heap","firstRender","helmets","state","contextValueRef","clientApply","defer","nextAnimFrameId","requestAnimationFrame","cancelAnimationFrame","update","id","props","idx","findIndex","item","splice","push","helmet","serverState","value"],"sources":["../../src/Provider.tsx"],"sourcesContent":["import {\n  type FunctionComponent,\n  type ReactNode,\n  createContext,\n  useRef,\n} from 'react';\n\nimport type {\n  ContextValue,\n  HelmetDataContext,\n  HelmetProps,\n  HelmetProviderHeap,\n} from './types';\n\nimport { newServerState } from './server';\nimport { IS_DOM_ENVIRONMENT } from './constants';\nimport { calcAggregatedState } from './utils';\nimport { commitTagChanges } from './client';\n\nexport const Context = createContext<ContextValue | undefined>(undefined);\n\ntype ProviderProps = {\n  children?: ReactNode;\n  context?: HelmetDataContext;\n};\n\nconst HelmetProvider: FunctionComponent<ProviderProps> = ({\n  children,\n  context,\n}) => {\n  const { current: heap } = useRef<HelmetProviderHeap>({\n    firstRender: true,\n    helmets: [],\n    state: undefined,\n  });\n\n  const contextValueRef = useRef<ContextValue>(null);\n\n  contextValueRef.current ??= {\n    clientApply() {\n      if (IS_DOM_ENVIRONMENT && !heap.state) {\n        heap.state = calcAggregatedState(heap.helmets);\n        if (heap.state.defer) {\n          heap.nextAnimFrameId ??= requestAnimationFrame(() => {\n            heap.state ??= calcAggregatedState(heap.helmets);\n            commitTagChanges(heap.state, heap.firstRender);\n            heap.firstRender = false;\n            delete heap.nextAnimFrameId;\n          });\n        } else {\n          if (heap.nextAnimFrameId !== undefined) {\n            cancelAnimationFrame(heap.nextAnimFrameId);\n            delete heap.nextAnimFrameId;\n          }\n          commitTagChanges(heap.state, heap.firstRender);\n          heap.firstRender = false;\n        }\n      }\n    },\n    update(id: string, props: HelmetProps | undefined) {\n      const idx = heap.helmets.findIndex((item) => item[0] === id);\n      if (idx >= 0) {\n        delete heap.state;\n        if (props) heap.helmets[idx]![1] = props;\n        else heap.helmets.splice(idx, 1);\n      } else if (props) {\n        delete heap.state;\n        heap.helmets.push([id, props]);\n      }\n    },\n  };\n\n  if (context && (!context.helmet || context.helmet !== heap.serverState)) {\n    heap.serverState ??= newServerState(heap);\n    context.helmet = heap.serverState;\n  }\n\n  return <Context value={contextValueRef.current}>{children}</Context>;\n};\n\nexport default HelmetProvider;\n"],"mappings":"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","ignoreList":[]}